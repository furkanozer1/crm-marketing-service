{% extends "base.html" %}

{% block title %}Campaigns{% endblock %}
{% block page_title %}Campaign Management{% endblock %}

{% block header_actions %}
<button class="btn btn-primary" onclick="openCreateCampaignModal()">+ Create Campaign</button>
{% endblock %}

{% block content %}
<div class="page-content">
    <!-- Filter Tabs -->
    <div class="filter-tabs">
        <button class="tab-btn active" onclick="filterCampaigns(this, '')">All</button>
        <button class="tab-btn" onclick="filterCampaigns(this, 'draft')">Draft</button>
        <button class="tab-btn" onclick="filterCampaigns(this, 'active')">Active</button>
        <button class="tab-btn" onclick="filterCampaigns(this, 'completed')">Completed</button>
    </div>

    <!-- Campaigns Table -->
    <div class="table-card">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Campaign</th>
                        <th>Type</th>
                        <th>Segment</th>
                        <th>Status</th>
                        <th>Budget</th>
                        <th>Performance</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="campaigns-table">
                    <tr>
                        <td colspan="7" class="loading-cell">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create Campaign Modal -->
<div id="create-campaign-modal" class="modal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h3>Create Campaign</h3>
            <button class="close-btn" onclick="closeModal('create-campaign-modal')">&times;</button>
        </div>
        <form id="create-campaign-form" onsubmit="handleCreateCampaign(event)">
            <div class="form-row">
                <div class="form-group">
                    <label for="campaign-name">Campaign Name *</label>
                    <input type="text" id="campaign-name" required placeholder="e.g., Summer Sale 2024">
                </div>
                <div class="form-group">
                    <label for="campaign-type">Campaign Type *</label>
                    <select id="campaign-type" required>
                        <option value="email">ğŸ“§ Email</option>
                        <option value="social">ğŸ“± Social Media</option>
                        <option value="ads">ğŸ“¢ Advertising</option>
                        <option value="sms">ğŸ’¬ SMS</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="campaign-description">Description</label>
                <textarea id="campaign-description" rows="2" placeholder="Campaign objectives and notes..."></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="campaign-segment">Target Segment *</label>
                    <select id="campaign-segment" required>
                        <option value="">-- Select Segment --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="campaign-budget">Budget ($)</label>
                    <input type="number" id="campaign-budget" step="0.01" min="0" placeholder="0.00">
                </div>
            </div>

            <div class="form-group" id="email-fields">
                <label for="campaign-subject">Email Subject</label>
                <input type="text" id="campaign-subject" placeholder="Your email subject line">
            </div>

            <div class="form-group">
                <label for="campaign-content">Content / Message</label>
                <textarea id="campaign-content" rows="4" placeholder="Enter your campaign message..."></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="campaign-schedule">Schedule (optional)</label>
                    <input type="datetime-local" id="campaign-schedule">
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary"
                    onclick="closeModal('create-campaign-modal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Campaign</button>
            </div>
        </form>
    </div>
</div>

<!-- Campaign Details Modal -->
<div id="campaign-details-modal" class="modal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h3 id="details-campaign-name">Campaign Details</h3>
            <button class="close-btn" onclick="closeModal('campaign-details-modal')">&times;</button>
        </div>
        <div id="campaign-details-content">Loading...</div>
    </div>
</div>

<script>
    let currentFilter = '';

    document.addEventListener('DOMContentLoaded', () => {
        loadCampaigns();
        loadSegmentsForDropdown();
    });

    async function loadSegmentsForDropdown() {
        try {
            const response = await fetch('/segments');
            const segments = await response.json();

            const select = document.getElementById('campaign-segment');
            segments.forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = `${s.name} (${s.customer_count} customers)`;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading segments:', error);
        }
    }

    async function loadCampaigns() {
        const params = currentFilter ? `?status=${currentFilter}` : '';

        try {
            const response = await fetch(`/campaigns${params}`);
            const campaigns = await response.json();
            renderCampaigns(campaigns);
        } catch (error) {
            console.error('Error loading campaigns:', error);
        }
    }

    function filterCampaigns(btn, status) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = status;
        loadCampaigns();
    }

    function renderCampaigns(campaigns) {
        const tbody = document.getElementById('campaigns-table');

        if (campaigns.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="empty-cell">No campaigns found</td></tr>';
            return;
        }

        tbody.innerHTML = campaigns.map(c => {
            const typeIcons = { email: 'ğŸ“§', social: 'ğŸ“±', ads: 'ğŸ“¢', sms: 'ğŸ’¬' };

            return `
        <tr>
            <td>
                <strong>${c.name}</strong>
                <div class="text-muted">${c.description || ''}</div>
            </td>
            <td><span class="type-badge ${c.campaign_type}">${typeIcons[c.campaign_type] || ''} ${c.campaign_type}</span></td>
            <td>${c.segment_name || '-'}</td>
            <td><span class="status-badge ${c.status}">${c.status}</span></td>
            <td>$${(c.budget || 0).toFixed(2)}</td>
            <td>
                ${c.status !== 'draft' ? `
                    <button class="btn btn-sm" onclick="viewCampaignStats(${c.id})">ğŸ“Š Stats</button>
                ` : '-'}
            </td>
            <td class="actions-cell">
                ${c.status === 'draft' ? `
                    <button class="btn btn-success btn-sm" onclick="launchCampaign(${c.id})">ğŸš€ Launch</button>
                ` : ''}
                ${c.status === 'active' ? `
                    <button class="btn btn-warning btn-sm" onclick="pauseCampaign(${c.id})">â¸ Pause</button>
                    <button class="btn btn-secondary btn-sm" onclick="completeCampaign(${c.id})">âœ“ Complete</button>
                ` : ''}
                ${c.status === 'paused' ? `
                    <button class="btn btn-success btn-sm" onclick="resumeCampaign(${c.id})">â–¶ Resume</button>
                ` : ''}
            </td>
        </tr>
    `}).join('');
    }

    function openCreateCampaignModal() {
        document.getElementById('create-campaign-form').reset();
        document.getElementById('create-campaign-modal').classList.add('show');
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('show');
    }

    async function handleCreateCampaign(e) {
        e.preventDefault();

        const data = {
            name: document.getElementById('campaign-name').value,
            campaign_type: document.getElementById('campaign-type').value,
            description: document.getElementById('campaign-description').value,
            segment_id: parseInt(document.getElementById('campaign-segment').value),
            budget: parseFloat(document.getElementById('campaign-budget').value) || 0,
            subject: document.getElementById('campaign-subject').value,
            content: document.getElementById('campaign-content').value,
            schedule_time: document.getElementById('campaign-schedule').value || null
        };

        try {
            const response = await fetch('/campaigns', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                closeModal('create-campaign-modal');
                loadCampaigns();
            } else {
                const error = await response.json();
                alert(error.error || 'Failed to create campaign');
            }
        } catch (error) {
            alert('Error creating campaign');
        }
    }

    async function launchCampaign(id) {
        if (!confirm('Launch this campaign? This will simulate sending to the target segment.')) return;

        try {
            await fetch(`/campaigns/${id}/launch`, { method: 'POST' });
            loadCampaigns();
        } catch (error) {
            console.error('Error launching campaign:', error);
        }
    }

    async function pauseCampaign(id) {
        try {
            await fetch(`/campaigns/${id}/pause`, { method: 'POST' });
            loadCampaigns();
        } catch (error) {
            console.error('Error pausing campaign:', error);
        }
    }

    async function resumeCampaign(id) {
        if (!confirm('Resume this campaign?')) return;
        try {
            await fetch(`/campaigns/${id}/resume`, { method: 'POST' });
            loadCampaigns();
        } catch (error) {
            console.error('Error resuming campaign:', error);
        }
    }

    async function completeCampaign(id) {
        try {
            await fetch(`/campaigns/${id}/complete`, { method: 'POST' });
            loadCampaigns();
        } catch (error) {
            console.error('Error completing campaign:', error);
        }
    }

    async function viewCampaignStats(id) {
        document.getElementById('campaign-details-modal').classList.add('show');
        document.getElementById('campaign-details-content').innerHTML = 'Loading...';

        try {
            const [campaign, stats] = await Promise.all([
                fetch(`/campaigns/${id}`).then(r => r.json()),
                fetch(`/campaigns/${id}/stats`).then(r => r.json())
            ]);

            document.getElementById('details-campaign-name').textContent = campaign.name;

            const roiClass = stats.roi >= 0 ? 'positive' : 'negative';

            document.getElementById('campaign-details-content').innerHTML = `
            <div class="stats-overview">
                <div class="stat-card">
                    <span class="stat-big">${stats.total_sent}</span>
                    <span class="stat-label">Total Sent</span>
                </div>
                <div class="stat-card">
                    <span class="stat-big">${stats.delivered}</span>
                    <span class="stat-label">Delivered (${stats.delivery_rate.toFixed(1)}%)</span>
                </div>
                <div class="stat-card">
                    <span class="stat-big">${stats.opens}</span>
                    <span class="stat-label">Opens (${stats.open_rate.toFixed(1)}%)</span>
                </div>
                <div class="stat-card">
                    <span class="stat-big">${stats.clicks}</span>
                    <span class="stat-label">Clicks (${stats.ctr.toFixed(1)}%)</span>
                </div>
                <div class="stat-card">
                    <span class="stat-big">${stats.conversions}</span>
                    <span class="stat-label">Conversions (${stats.conversion_rate.toFixed(1)}%)</span>
                </div>
            </div>
            
            <div class="financial-stats">
                <h4>Financial Performance</h4>
                <div class="stats-row">
                    <div class="stat-item">
                        <span class="label">Revenue Attributed:</span>
                        <span class="value positive">$${stats.revenue_attributed.toFixed(2)}</span>
                    </div>
                    <div class="stat-item">
                        <span class="label">Total Cost:</span>
                        <span class="value negative">$${stats.total_cost.toFixed(2)}</span>
                    </div>
                    <div class="stat-item highlight">
                        <span class="label">ROI:</span>
                        <span class="value ${roiClass}">${stats.roi.toFixed(1)}%</span>
                    </div>
                </div>
            </div>
            
            <div class="leads-stats">
                <h4>Lead Generation</h4>
                <div class="stats-row">
                    <div class="stat-item">
                        <span class="label">Leads Generated:</span>
                        <span class="value">${stats.leads_generated}</span>
                    </div>
                    <div class="stat-item">
                        <span class="label">Leads Converted:</span>
                        <span class="value">${stats.leads_converted}</span>
                    </div>
                </div>
            </div>
        `;
        } catch (error) {
            document.getElementById('campaign-details-content').innerHTML = 'Error loading campaign stats';
        }
    }
</script>
{% endblock %}